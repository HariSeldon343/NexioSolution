<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Debug - Nexio Mobile</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .debug-panel { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            border-radius: 4px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            white-space: pre-wrap; 
        }
        
        .calendar-simple {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            padding: 10px;
        }
        .calendar-day {
            background: white;
            padding: 10px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-day.has-events {
            background: #e3f2fd;
            font-weight: bold;
        }
        .calendar-day.today {
            background: #2196f3;
            color: white;
        }
        
        .event-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .event-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .event-item:last-child { border-bottom: none; }
        .event-title { font-weight: bold; color: #333; }
        .event-time { color: #666; font-size: 0.9em; }
        
        h1 { color: #2c3e50; margin-bottom: 20px; }
        h2 { color: #34495e; margin: 15px 0 10px 0; }
        h3 { color: #7f8c8d; margin: 10px 0 5px 0; }
        
        .step-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #ccc;
            color: white;
            text-align: center;
            line-height: 24px;
            border-radius: 50%;
            font-size: 12px;
            margin-right: 10px;
        }
        .step-indicator.active { background: #007bff; }
        .step-indicator.success { background: #28a745; }
        .step-indicator.error { background: #dc3545; }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: #007bff;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóì Nexio Calendar Debug</h1>
        
        <div class="debug-panel">
            <h2>üöÄ Avvio Debug Sistematico</h2>
            <p>Questa pagina esegue un debug step-by-step per identificare i problemi del calendario mobile.</p>
            
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            
            <button onclick="startDebugSequence()" id="startBtn">‚ñ∂ Avvia Debug Completo</button>
            <button onclick="clearAllLogs()" id="clearBtn">üóë Pulisci Log</button>
            <button onclick="showSimpleCalendar()" id="calendarBtn">üìÖ Mostra Calendario Semplice</button>
        </div>
        
        <div id="debugSteps" class="debug-panel" style="display: none;">
            <h2>üìã Passi Debug</h2>
            <div id="stepsContainer"></div>
        </div>
        
        <div id="consoleLog" class="debug-panel">
            <h2>üìù Log Console</h2>
            <div id="logArea" class="log">Console log apparir√† qui...\n</div>
        </div>
        
        <div id="calendarDisplay" class="debug-panel" style="display: none;">
            <h2>üìÖ Calendario Semplificato</h2>
            <div id="calendarContainer"></div>
            <div id="eventsContainer" class="event-list"></div>
        </div>
        
        <div id="apiTests" class="debug-panel">
            <h2>üîß Test API Diretti</h2>
            <button onclick="testApiDirect()">Test API Diretto</button>
            <button onclick="testAuthentication()">Test Autenticazione</button>
            <button onclick="testDatabase()">Test Connessione DB</button>
            <div id="apiResults"></div>
        </div>
    </div>

    <script>
        // Global debug variables
        let debugLog = '';
        let debugSteps = [];
        let currentStep = 0;
        let calendarData = {
            events: [],
            currentDate: new Date(),
            isLoading: false,
            errors: []
        };
        
        // Enhanced console logging
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, arguments);
            logToDebugArea('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, arguments);
            logToDebugArea('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, arguments);
            logToDebugArea('WARN', args.join(' '));
        };
        
        function logToDebugArea(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${level}: ${message}\n`;
            debugLog += logEntry;
            
            const logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.textContent = debugLog;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        
        function clearAllLogs() {
            debugLog = '';
            const logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.textContent = 'Console log pulito...\n';
            }
            console.log('Log puliti - riavvio debug');
        }
        
        // Debug Steps Configuration
        const DEBUG_STEPS = [
            {
                id: 'init',
                name: 'Inizializzazione',
                description: 'Verifica caricamento pagina e ambiente',
                test: testInitialization
            },
            {
                id: 'dom',
                name: 'Verifica DOM',
                description: 'Controllo elementi DOM necessari',
                test: testDOMElements
            },
            {
                id: 'network',
                name: 'Test Network',
                description: 'Verifica connettivit√† di base',
                test: testNetworkConnectivity
            },
            {
                id: 'auth',
                name: 'Test Autenticazione',
                description: 'Verifica stato sessione utente',
                test: testUserAuthentication
            },
            {
                id: 'api-basic',
                name: 'API Base',
                description: 'Test connessione API calendar-events.php',
                test: testBasicAPI
            },
            {
                id: 'api-params',
                name: 'API con Parametri',
                description: 'Test API con parametri data',
                test: testAPIWithParams
            },
            {
                id: 'data-processing',
                name: 'Elaborazione Dati',
                description: 'Test parsing e gestione dati eventi',
                test: testDataProcessing
            },
            {
                id: 'calendar-render',
                name: 'Rendering Calendario',
                description: 'Test rendering calendario e eventi',
                test: testCalendarRendering
            }
        ];
        
        async function startDebugSequence() {
            console.log('üöÄ Avvio debug sequence completa');
            
            const stepsDiv = document.getElementById('debugSteps');
            const startBtn = document.getElementById('startBtn');
            
            stepsDiv.style.display = 'block';
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ Debug in corso...';
            
            currentStep = 0;
            
            // Crea UI per gli step
            createStepsUI();
            
            // Esegui tutti i test in sequenza
            for (let i = 0; i < DEBUG_STEPS.length; i++) {
                currentStep = i;
                updateProgress(i, DEBUG_STEPS.length);
                await executeDebugStep(DEBUG_STEPS[i], i);
                await delay(500); // Pausa tra i test
            }
            
            updateProgress(DEBUG_STEPS.length, DEBUG_STEPS.length);
            startBtn.disabled = false;
            startBtn.textContent = '‚úÖ Debug Completato';
            
            console.log('‚úÖ Debug sequence completata');
            generateDebugReport();
        }
        
        function createStepsUI() {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';
            
            DEBUG_STEPS.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'status info';
                stepDiv.id = `step-${index}`;
                stepDiv.innerHTML = `
                    <span class="step-indicator" id="indicator-${index}">${index + 1}</span>
                    <strong>${step.name}</strong> - ${step.description}
                    <div id="result-${index}" style="margin-top: 10px; font-family: monospace;"></div>
                `;
                container.appendChild(stepDiv);
            });
        }
        
        async function executeDebugStep(step, index) {
            console.log(`üìã Eseguendo step ${index + 1}: ${step.name}`);
            
            const stepDiv = document.getElementById(`step-${index}`);
            const indicator = document.getElementById(`indicator-${index}`);
            const resultDiv = document.getElementById(`result-${index}`);
            
            // Marca come attivo
            stepDiv.className = 'status info';
            indicator.className = 'step-indicator active';
            
            try {
                const result = await step.test();
                
                if (result.success) {
                    stepDiv.className = 'status success';
                    indicator.className = 'step-indicator success';
                    resultDiv.innerHTML = `‚úÖ ${result.message}`;
                } else {
                    stepDiv.className = 'status error';
                    indicator.className = 'step-indicator error';
                    resultDiv.innerHTML = `‚ùå ${result.message}`;
                }
                
                if (result.details) {
                    resultDiv.innerHTML += `<br><small>${result.details}</small>`;
                }
                
            } catch (error) {
                console.error(`Errore step ${step.name}:`, error);
                stepDiv.className = 'status error';
                indicator.className = 'step-indicator error';
                resultDiv.innerHTML = `üí• Errore: ${error.message}`;
            }
        }
        
        function updateProgress(current, total) {
            const progressBar = document.getElementById('progressBar');
            const percentage = (current / total) * 100;
            progressBar.style.width = percentage + '%';
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Test Functions
        async function testInitialization() {
            const info = {
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 50) + '...',
                cookies: navigator.cookieEnabled,
                storage: typeof(Storage) !== "undefined",
                fetch: typeof(fetch) !== "undefined"
            };
            
            console.log('Inizializzazione:', info);
            
            return {
                success: true,
                message: 'Ambiente browser OK',
                details: `URL: ${info.url}, Cookies: ${info.cookies}, Storage: ${info.storage}`
            };
        }
        
        async function testDOMElements() {
            const requiredElements = [
                'debugSteps', 'logArea', 'calendarDisplay', 'apiResults'
            ];
            
            const missing = [];
            const found = [];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    found.push(id);
                } else {
                    missing.push(id);
                }
            });
            
            console.log('DOM Check - Trovati:', found, 'Mancanti:', missing);
            
            return {
                success: missing.length === 0,
                message: missing.length === 0 ? 'Tutti gli elementi DOM presenti' : `Elementi mancanti: ${missing.join(', ')}`,
                details: `Trovati: ${found.length}, Mancanti: ${missing.length}`
            };
        }
        
        async function testNetworkConnectivity() {
            try {
                // Test connessione base al server
                const response = await fetch('../index.php', { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                console.log('Network test:', response.status, response.statusText);
                
                return {
                    success: response.status < 400,
                    message: `Server raggiungibile (${response.status})`,
                    details: `Status: ${response.status} ${response.statusText}`
                };
                
            } catch (error) {
                console.error('Network test failed:', error);
                return {
                    success: false,
                    message: 'Server non raggiungibile',
                    details: error.message
                };
            }
        }
        
        async function testUserAuthentication() {
            try {
                // Test multipli per autenticazione
                const tests = [];
                
                // Test 1: index.php (dovrebbe non redirectare a login)
                try {
                    const indexResponse = await fetch('../index.php', { credentials: 'same-origin' });
                    const indexText = await indexResponse.text();
                    const hasLogin = indexText.includes('login.php') || indexText.includes('form-signin');
                    tests.push(`Index: ${hasLogin ? 'Non autenticato' : 'Autenticato'}`);
                } catch (e) {
                    tests.push(`Index: Errore - ${e.message}`);
                }
                
                // Test 2: API diretta calendar-events
                try {
                    const apiResponse = await fetch('../backend/api/calendar-events.php', { 
                        credentials: 'same-origin',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    tests.push(`API: ${apiResponse.status} ${apiResponse.statusText}`);
                    
                    if (apiResponse.status === 401) {
                        return {
                            success: false,
                            message: 'Utente non autenticato',
                            details: tests.join(', ')
                        };
                    } else if (apiResponse.status < 400) {
                        return {
                            success: true,
                            message: 'Utente autenticato',
                            details: tests.join(', ')
                        };
                    }
                } catch (e) {
                    tests.push(`API: Errore - ${e.message}`);
                }
                
                console.log('Auth tests:', tests);
                
                return {
                    success: false,
                    message: 'Stato autenticazione unclear',
                    details: tests.join(', ')
                };
                
            } catch (error) {
                console.error('Auth test failed:', error);
                return {
                    success: false,
                    message: 'Errore test autenticazione',
                    details: error.message
                };
            }
        }
        
        async function testBasicAPI() {
            try {
                console.log('Testing basic API call...');
                
                const response = await fetch('../backend/api/calendar-events.php', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                console.log('API Response:', response.status, response.statusText);
                
                const responseText = await response.text();
                console.log('API Response Text:', responseText.substring(0, 200));
                
                if (response.status === 401) {
                    return {
                        success: false,
                        message: 'API richiede autenticazione',
                        details: `Status: ${response.status}, Response: ${responseText.substring(0, 100)}`
                    };
                }
                
                if (!response.ok) {
                    return {
                        success: false,
                        message: `API error ${response.status}`,
                        details: responseText.substring(0, 200)
                    };
                }
                
                // Verifica se √® JSON valido
                let jsonData;
                try {
                    jsonData = JSON.parse(responseText);
                } catch (e) {
                    return {
                        success: false,
                        message: 'API response non √® JSON valido',
                        details: `Response: ${responseText.substring(0, 100)}`
                    };
                }
                
                console.log('Parsed JSON:', jsonData);
                
                return {
                    success: true,
                    message: 'API raggiungibile e funzionante',
                    details: `Success: ${jsonData.success}, Events: ${jsonData.events ? jsonData.events.length : 'N/A'}`
                };
                
            } catch (error) {
                console.error('Basic API test failed:', error);
                return {
                    success: false,
                    message: 'Errore connessione API',
                    details: error.message
                };
            }
        }
        
        async function testAPIWithParams() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const url = `../backend/api/calendar-events.php?start=${today}&end=${today}`;
                
                console.log('Testing API with params:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    return {
                        success: false,
                        message: `API error ${response.status}`,
                        details: errorText.substring(0, 200)
                    };
                }
                
                const data = await response.json();
                console.log('API with params response:', data);
                
                calendarData.events = data.events || [];
                
                return {
                    success: data.success !== false,
                    message: `API con parametri OK (${calendarData.events.length} eventi)`,
                    details: `Start: ${today}, Events: ${calendarData.events.length}`
                };
                
            } catch (error) {
                console.error('API with params test failed:', error);
                return {
                    success: false,
                    message: 'Errore API con parametri',
                    details: error.message
                };
            }
        }
        
        async function testDataProcessing() {
            try {
                const events = calendarData.events || [];
                
                if (events.length === 0) {
                    return {
                        success: true,
                        message: 'Nessun evento da processare',
                        details: 'Database eventi vuoto'
                    };
                }
                
                // Test processing degli eventi
                let validEvents = 0;
                let errors = [];
                
                events.forEach((event, index) => {
                    try {
                        if (event.id && event.title && event.start_time) {
                            validEvents++;
                        } else {
                            errors.push(`Event ${index}: missing fields`);
                        }
                        
                        // Test date parsing
                        const startDate = new Date(event.start_time);
                        if (isNaN(startDate.getTime())) {
                            errors.push(`Event ${index}: invalid start_time`);
                        }
                    } catch (e) {
                        errors.push(`Event ${index}: ${e.message}`);
                    }
                });
                
                console.log(`Data processing: ${validEvents}/${events.length} valid events`);
                
                return {
                    success: errors.length === 0,
                    message: `${validEvents}/${events.length} eventi validi`,
                    details: errors.length > 0 ? errors.join(', ') : 'Tutti i dati sono validi'
                };
                
            } catch (error) {
                console.error('Data processing test failed:', error);
                return {
                    success: false,
                    message: 'Errore processing dati',
                    details: error.message
                };
            }
        }
        
        async function testCalendarRendering() {
            try {
                console.log('Testing calendar rendering...');
                
                const calendarDiv = document.getElementById('calendarDisplay');
                const container = document.getElementById('calendarContainer');
                const eventsContainer = document.getElementById('eventsContainer');
                
                if (!container) {
                    return {
                        success: false,
                        message: 'Elemento calendario non trovato',
                        details: 'calendarContainer element missing'
                    };
                }
                
                // Mostra il calendario
                calendarDiv.style.display = 'block';
                
                // Rendering semplice
                renderSimpleCalendar(container);
                renderEventsList(eventsContainer);
                
                return {
                    success: true,
                    message: 'Calendario renderizzato con successo',
                    details: `Eventi: ${calendarData.events.length}`
                };
                
            } catch (error) {
                console.error('Calendar rendering test failed:', error);
                return {
                    success: false,
                    message: 'Errore rendering calendario',
                    details: error.message
                };
            }
        }
        
        // Calendar Rendering Functions
        function showSimpleCalendar() {
            const calendarDiv = document.getElementById('calendarDisplay');
            const container = document.getElementById('calendarContainer');
            const eventsContainer = document.getElementById('eventsContainer');
            
            calendarDiv.style.display = 'block';
            
            renderSimpleCalendar(container);
            renderEventsList(eventsContainer);
            
            console.log('Simple calendar displayed');
        }
        
        function renderSimpleCalendar(container) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get first day of month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // Month header
            const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            
            let html = `<h3>${monthNames[currentMonth]} ${currentYear}</h3>`;
            html += '<div class="calendar-simple">';
            
            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day" style="font-weight: bold; background: #f8f9fa;">${day}</div>`;
            });
            
            // Empty cells for days before month starts
            for (let i = 0; i < startingDay; i++) {
                html += '<div class="calendar-day" style="background: #f8f9fa;"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const isToday = date.toDateString() === today.toDateString();
                const hasEvents = hasEventsOnDate(date);
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasEvents) classes += ' has-events';
                
                html += `<div class="${classes}">${day}</div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderEventsList(container) {
            const events = calendarData.events || [];
            
            if (events.length === 0) {
                container.innerHTML = '<div class="event-item">Nessun evento trovato</div>';
                return;
            }
            
            let html = '';
            events.forEach(event => {
                const startTime = event.start_time || event.data_inizio;
                const endTime = event.end_time || event.data_fine;
                
                html += `
                    <div class="event-item">
                        <div class="event-title">${event.title || event.titolo || 'Evento senza titolo'}</div>
                        <div class="event-time">
                            ${formatDateTime(startTime)} - ${formatDateTime(endTime)}
                        </div>
                        ${event.location || event.luogo ? `<div>üìç ${event.location || event.luogo}</div>` : ''}
                        ${event.description || event.descrizione ? `<div>${event.description || event.descrizione}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Helper Functions
        function hasEventsOnDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return calendarData.events.some(event => {
                const eventDate = new Date(event.start_time || event.data_inizio).toISOString().split('T')[0];
                return eventDate === dateString;
            });
        }
        
        function formatDateTime(datetime) {
            if (!datetime) return 'N/A';
            try {
                const date = new Date(datetime);
                return date.toLocaleString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return datetime;
            }
        }
        
        // Direct API Tests
        async function testApiDirect() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="status info">Testing API...</div>';
            
            try {
                const response = await fetch('../backend/api/calendar-events.php?start=2025-01-01&end=2025-12-31', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const text = await response.text();
                let data;
                
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Response not JSON: ${text.substring(0, 200)}`);
                }
                
                resultsDiv.innerHTML = `
                    <div class="status success">
                        <strong>API Test Success!</strong><br>
                        Status: ${response.status}<br>
                        Events: ${data.events ? data.events.length : 0}<br>
                        Success: ${data.success}<br>
                        <details><summary>Full Response</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <strong>API Test Failed!</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testAuthentication() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="status info">Testing Authentication...</div>';
            
            try {
                const response = await fetch('../index.php', { credentials: 'same-origin' });
                const text = await response.text();
                
                const isLoggedIn = !text.includes('login.php') && !text.includes('form-signin');
                
                resultsDiv.innerHTML = `
                    <div class="status ${isLoggedIn ? 'success' : 'warning'}">
                        <strong>Authentication Test</strong><br>
                        Status: ${response.status}<br>
                        Logged In: ${isLoggedIn ? 'YES' : 'NO'}<br>
                        Response Size: ${text.length} chars<br>
                        Contains Login: ${text.includes('login.php') ? 'YES' : 'NO'}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <strong>Auth Test Failed!</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testDatabase() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="status info">Testing Database Connection...</div>';
            
            // This would require a specific endpoint to test DB
            resultsDiv.innerHTML = `
                <div class="status warning">
                    <strong>Database Test</strong><br>
                    Direct DB test not available from frontend.<br>
                    Check server logs for database errors.<br>
                    API tests above indicate DB connectivity.
                </div>
            `;
        }
        
        function generateDebugReport() {
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                steps: DEBUG_STEPS.length,
                events: calendarData.events.length,
                errors: calendarData.errors.length,
                logLength: debugLog.length
            };
            
            console.log('üìä DEBUG REPORT:', report);
            
            // Add summary to log
            logToDebugArea('REPORT', `Debug completato: ${report.steps} steps, ${report.events} eventi, ${report.errors} errori`);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üèÅ Calendar Debug page loaded');
            console.log('URL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            console.log('Cookies enabled:', navigator.cookieEnabled);
            
            // Auto-start basic tests after short delay
            setTimeout(() => {
                console.log('Ready for debugging. Click "Avvia Debug Completo" to start.');
            }, 1000);
        });
        
        // Catch all unhandled errors
        window.addEventListener('error', (event) => {
            console.error('Unhandled error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>