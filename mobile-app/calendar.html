<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- PWA Essential Meta Tags -->
    <title>Nexio Calendar</title>
    <meta name="description" content="Nexio Calendar - Gestione calendario mobile">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="./icons/icon-192.svg">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.svg">
    
    <!-- CSS -->
    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/app.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-3">
                    <a href="./index.html" class="btn btn-link p-0">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <div class="col-6 text-center">
                    <h1 class="app-title h5 mb-0">Calendario</h1>
                </div>
                <div class="col-3 text-end">
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshCalendar()" title="Aggiorna eventi">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="addNewEvent()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container-fluid">
            <!-- Calendar Controls -->
            <div class="calendar-controls mb-3">
                <div class="row align-items-center">
                    <div class="col-3">
                        <button class="btn btn-outline-primary btn-sm" id="prevMonth">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div class="col-6 text-center">
                        <h4 id="currentMonth" class="mb-0"></h4>
                    </div>
                    <div class="col-3 text-end">
                        <button class="btn btn-outline-primary btn-sm" id="nextMonth">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- View Toggle -->
                <div class="btn-group w-100 mt-3" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm active" id="monthView">Mese</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="weekView">Settimana</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="dayView">Giorno</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="listView">Lista</button>
                </div>
            </div>

            <!-- Calendar Display -->
            <div id="calendarDisplay" class="calendar-display">
                <div id="calendarGrid" class="calendar-grid">
                    <!-- Calendar content will be rendered here -->
                </div>
            </div>

            <!-- Event List -->
            <div class="events-section mt-4">
                <h5>Eventi</h5>
                <div id="eventsList" class="events-list">
                    <!-- Events will be loaded here -->
                </div>
                <div id="todayEventsList" class="events-list">
                    <!-- Today's events will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Event Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Dettagli Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Event details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentEvent()">Modifica</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento eventi...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="./js/calendar.js"></script>
    
    <script>
        // Enhanced Calendar functionality for standalone view
        class StandaloneCalendarManager extends CalendarManager {
            constructor() {
                super();
                this.setupStandaloneFeatures();
            }
            
            setupStandaloneFeatures() {
                // Add list view functionality
                const listViewBtn = document.getElementById('listView');
                if (listViewBtn) {
                    listViewBtn.addEventListener('click', () => this.switchView('list'));
                }
                
                // Enhanced event display
                this.renderDisplay = document.getElementById('calendarDisplay');
            }
            
            switchView(viewType) {
                super.switchView(viewType);
                
                if (viewType === 'list') {
                    this.renderListView();
                }
            }
            
            renderListView() {
                if (!this.renderDisplay) return;
                
                const events = this.getEventsForCurrentPeriod();
                
                let listHTML = '<div class="list-view">';
                
                if (events.length === 0) {
                    listHTML += '<p class="text-muted text-center py-4">Nessun evento nel periodo selezionato</p>';
                } else {
                    events.forEach(event => {
                        const eventDate = new Date(event.start_time);
                        listHTML += `
                            <div class="list-event-item" onclick="window.CalendarManager.showEventDetails(${event.id})">
                                <div class="list-event-date">
                                    ${eventDate.toLocaleDateString('it-IT', { 
                                        weekday: 'short', 
                                        day: 'numeric', 
                                        month: 'short' 
                                    })}
                                </div>
                                <div class="list-event-content">
                                    <div class="list-event-title">${event.title}</div>
                                    <div class="list-event-time">
                                        ${this.formatTime(event.start_time)} - ${this.formatTime(event.end_time)}
                                    </div>
                                    ${event.description ? `<div class="list-event-description">${event.description}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                listHTML += '</div>';
                this.renderDisplay.innerHTML = listHTML;
            }
            
            getEventsForCurrentPeriod() {
                // Return events for current month/week/day based on current view
                return this.events.filter(event => {
                    const eventDate = new Date(event.start_time);
                    const currentMonth = this.currentDate.getMonth();
                    const currentYear = this.currentDate.getFullYear();
                    
                    return eventDate.getMonth() === currentMonth && 
                           eventDate.getFullYear() === currentYear;
                });
            }
            
            showEventDetails(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const modalBody = document.getElementById('eventModalBody');
                const modal = document.getElementById('eventModal');
                
                modalBody.innerHTML = `
                    <div class="event-details">
                        <h6>${event.title}</h6>
                        <p class="text-muted">
                            <i class="fas fa-calendar me-2"></i>
                            ${new Date(event.start_time).toLocaleDateString('it-IT')}
                        </p>
                        <p class="text-muted">
                            <i class="fas fa-clock me-2"></i>
                            ${this.formatTime(event.start_time)} - ${this.formatTime(event.end_time)}
                        </p>
                        ${event.location ? `<p><i class="fas fa-map-marker-alt me-2"></i>${event.location}</p>` : ''}
                        ${event.description ? `<p>${event.description}</p>` : ''}
                    </div>
                `;
                
                // Store current event for editing
                this.currentEvent = event;
                
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }
        }
        
        // Global functions
        window.addNewEvent = function() {
            alert('Funzione aggiungi evento in sviluppo');
        };
        
        window.editCurrentEvent = function() {
            alert('Funzione modifica evento in sviluppo');
        };
        
        window.refreshCalendar = function() {
            if (window.CalendarManager) {
                window.CalendarManager.refresh();
            }
        };
        
        // Initialize enhanced calendar
        document.addEventListener('DOMContentLoaded', () => {
            window.CalendarManager = new StandaloneCalendarManager();
        });
    </script>
</body>
</html>