<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Mobile Nexio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:active {
            background: #2980b9;
        }

        .month-title {
            font-size: 18px;
            font-weight: bold;
        }

        .calendar {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #34495e;
            color: white;
        }

        .calendar-header div {
            padding: 12px 4px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            min-height: 60px;
            border: 1px solid #e0e0e0;
            padding: 4px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-day:hover {
            background: #ecf0f1;
        }

        .calendar-day.other-month {
            color: #bdc3c7;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #3498db;
            color: white;
        }

        .calendar-day.has-events {
            background: #e8f5e8;
        }

        .calendar-day.has-events.today {
            background: #27ae60;
        }

        .day-number {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            background: #e74c3c;
            border-radius: 50%;
            display: inline-block;
            margin: 1px;
        }

        .event-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .controls {
            margin: 15px 0;
            text-align: center;
        }

        .load-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .load-btn:active {
            background: #219a52;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .event-list {
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .event-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .event-time {
            color: #7f8c8d;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .calendar-day {
                min-height: 50px;
                padding: 2px;
            }
            
            .day-number {
                font-size: 12px;
            }
            
            .calendar-header div {
                padding: 8px 2px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Calendario Nexio</h1>
        <div>Versione Mobile Semplificata</div>
    </div>

    <div class="container">
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">‚Üê Prec</button>
            <div class="month-title" id="monthTitle">Gennaio 2025</div>
            <button class="nav-btn" onclick="changeMonth(1)">Succ ‚Üí</button>
        </div>

        <div class="controls">
            <button class="load-btn" onclick="loadEventiDemo()">Carica Eventi Demo</button>
            <button class="load-btn" onclick="loadEventiReali()">Carica Dal Database</button>
        </div>

        <div id="status" class="status info" style="display: none;"></div>

        <div class="calendar">
            <div class="calendar-header">
                <div>Lun</div>
                <div>Mar</div>
                <div>Mer</div>
                <div>Gio</div>
                <div>Ven</div>
                <div>Sab</div>
                <div>Dom</div>
            </div>
            <div class="calendar-body" id="calendarBody">
                <!-- Giorni del calendario saranno inseriti qui -->
            </div>
        </div>

        <div class="event-list" id="eventList" style="display: none;">
            <div class="loading">Nessun evento da visualizzare</div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentDate = new Date();
        let events = {};

        // Nomi dei mesi
        const monthNames = [
            'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
            'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
        ];

        // Eventi demo hardcoded
        const eventiDemo = {
            '2025-01-08': [
                { titolo: 'Riunione Team', ora: '09:00', descrizione: 'Meeting settimanale' },
                { titolo: 'Presentazione Progetto', ora: '14:30', descrizione: 'Presentazione cliente' }
            ],
            '2025-01-10': [
                { titolo: 'Formazione', ora: '10:00', descrizione: 'Corso aggiornamento' }
            ],
            '2025-01-15': [
                { titolo: 'Scadenza Documenti', ora: '16:00', descrizione: 'Consegna report' },
                { titolo: 'Call con Cliente', ora: '18:00', descrizione: 'Follow-up progetto' }
            ],
            '2025-01-20': [
                { titolo: 'Revisione Codice', ora: '11:00', descrizione: 'Code review' }
            ]
        };

        // Inizializza calendario
        function init() {
            showStatus('Calendario inizializzato correttamente', 'success');
            renderCalendar();
            loadEventiDemo(); // Carica eventi demo all'avvio
        }

        // Mostra messaggio di stato
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Cambia mese
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // Renderizza calendario
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Aggiorna titolo
            document.getElementById('monthTitle').textContent = `${monthNames[month]} ${year}`;
            
            // Calcola primo giorno del mese (luned√¨ = 1, domenica = 0)
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 7 : startDay; // Converti domenica da 0 a 7
            
            // Calcola giorni da mostrare
            const daysInMonth = lastDay.getDate();
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            // Giorni del mese precedente
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startDay - 2; i >= 0; i--) {
                const dayNum = prevMonth.getDate() - i;
                const dayEl = createDayElement(dayNum, true);
                calendarBody.appendChild(dayEl);
            }
            
            // Giorni del mese corrente
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getFullYear() === year && 
                               today.getMonth() === month && 
                               today.getDate() === day;
                
                const dayEl = createDayElement(day, false, isToday);
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Aggiungi eventi se presenti
                if (events[dateKey]) {
                    dayEl.classList.add('has-events');
                    const eventCount = document.createElement('div');
                    eventCount.className = 'event-count';
                    eventCount.textContent = events[dateKey].length;
                    dayEl.appendChild(eventCount);
                }
                
                calendarBody.appendChild(dayEl);
            }
            
            // Giorni del mese successivo per completare la griglia
            const totalCells = calendarBody.children.length;
            const remainingCells = 42 - totalCells; // 6 settimane x 7 giorni
            for (let day = 1; day <= Math.min(remainingCells, 14); day++) {
                const dayEl = createDayElement(day, true);
                calendarBody.appendChild(dayEl);
            }
        }

        // Crea elemento giorno
        function createDayElement(dayNum, otherMonth = false, isToday = false) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            
            if (otherMonth) dayEl.classList.add('other-month');
            if (isToday) dayEl.classList.add('today');
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = dayNum;
            dayEl.appendChild(dayNumber);
            
            dayEl.onclick = () => {
                if (!otherMonth) {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    showEventsForDate(dateKey);
                }
            };
            
            return dayEl;
        }

        // Carica eventi demo
        function loadEventiDemo() {
            events = { ...eventiDemo };
            renderCalendar();
            showStatus('Eventi demo caricati con successo!', 'success');
            showEventList();
        }

        // Carica eventi reali dal database
        function loadEventiReali() {
            showStatus('Caricamento eventi dal database...', 'info');
            
            fetch('../backend/api/eventi-semplice.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        events = data.eventi || {};
                        renderCalendar();
                        showStatus(`Caricati ${Object.keys(events).length} giorni con eventi dal database`, 'success');
                        showEventList();
                    } else {
                        throw new Error(data.message || 'Errore sconosciuto dal server');
                    }
                })
                .catch(error => {
                    console.error('Errore caricamento eventi:', error);
                    showStatus(`Errore: ${error.message}. Uso eventi demo.`, 'error');
                    loadEventiDemo(); // Fallback agli eventi demo
                });
        }

        // Mostra eventi per una data specifica
        function showEventsForDate(dateKey) {
            const dayEvents = events[dateKey];
            if (!dayEvents || dayEvents.length === 0) {
                showStatus('Nessun evento per questa data', 'info');
                return;
            }
            
            const [year, month, day] = dateKey.split('-');
            const dateStr = `${day}/${month}/${year}`;
            
            let html = `<div style="padding: 10px; background: #34495e; color: white; font-weight: bold;">
                Eventi per ${dateStr}
            </div>`;
            
            dayEvents.forEach(event => {
                html += `
                    <div class="event-item">
                        <div class="event-title">${event.titolo}</div>
                        <div class="event-time">üïê ${event.ora}</div>
                        ${event.descrizione ? `<div style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">${event.descrizione}</div>` : ''}
                    </div>
                `;
            });
            
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = html;
            eventList.style.display = 'block';
            
            // Scroll verso la lista eventi
            eventList.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Mostra lista di tutti gli eventi
        function showEventList() {
            const eventList = document.getElementById('eventList');
            const totalEvents = Object.values(events).reduce((sum, dayEvents) => sum + dayEvents.length, 0);
            
            if (totalEvents === 0) {
                eventList.innerHTML = '<div class="loading">Nessun evento da visualizzare</div>';
                eventList.style.display = 'block';
                return;
            }
            
            let html = `<div style="padding: 10px; background: #34495e; color: white; font-weight: bold;">
                Tutti gli Eventi (${totalEvents})
            </div>`;
            
            // Ordina le date
            const sortedDates = Object.keys(events).sort();
            
            sortedDates.forEach(dateKey => {
                const dayEvents = events[dateKey];
                if (dayEvents && dayEvents.length > 0) {
                    const [year, month, day] = dateKey.split('-');
                    const dateStr = `${day}/${month}/${year}`;
                    
                    dayEvents.forEach(event => {
                        html += `
                            <div class="event-item">
                                <div class="event-title">${event.titolo}</div>
                                <div class="event-time">üìÖ ${dateStr} - üïê ${event.ora}</div>
                                ${event.descrizione ? `<div style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">${event.descrizione}</div>` : ''}
                            </div>
                        `;
                    });
                }
            });
            
            eventList.innerHTML = html;
            eventList.style.display = 'block';
        }

        // Inizializza quando la pagina √® caricata
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>