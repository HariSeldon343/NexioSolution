<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug API Calendar</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .step.success { border-left-color: #28a745; }
        .step.error { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>Debug Mobile App Calendar - Test API</h1>
    
    <div class="debug-section info">
        <h3>üîç Test Sistematico API Calendar</h3>
        <p>Questo strumento esegue test step-by-step per identificare il problema</p>
        <button onclick="runAllTests()">‚ñ∂ Esegui Tutti i Test</button>
        <button onclick="clearResults()">üóë Pulisci Risultati</button>
    </div>
    
    <div id="testResults"></div>
    
    <div class="debug-section">
        <h3>üìã Test Manuali</h3>
        <button onclick="testStep1()">1. Test Path Relativi</button>
        <button onclick="testStep2()">2. Test Path Assoluti</button>
        <button onclick="testStep3()">3. Test con Parametri</button>
        <button onclick="testStep4()">4. Test Autenticazione</button>
        <button onclick="testStep5()">5. Test Headers</button>
        <button onclick="testStep6()">6. Test Browser Info</button>
    </div>
    
    <script>
        let debugDiv;
        let testCount = 0;
        
        function clearResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            testCount = 0;
        }
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            testCount++;
            
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = `
                <h4>${testCount}. ${title}</h4>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function runAllTests() {
            clearResults();
            addResult("üöÄ Avvio Test Completi", "Eseguendo tutti i test in sequenza...", "info");
            
            await testStep6(); // Browser info prima
            await delay(500);
            await testStep1(); // Path relativi
            await delay(500);
            await testStep2(); // Path assoluti
            await delay(500);
            await testStep4(); // Autenticazione
            await delay(500);
            await testStep3(); // Con parametri
            await delay(500);
            await testStep5(); // Headers
            
            addResult("‚úÖ Test Completati", "Tutti i test sono stati eseguiti. Analizza i risultati sopra.", "success");
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function testStep1() {
            addResult("üîç Test 1: Path Relativi", "Testando path relativi per l'API...", "info");
            
            try {
                const response = await fetch('../backend/api/calendar-events.php', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                addResult("Path Relativo ../backend/api/calendar-events.php", `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>StatusText:</strong> ${response.statusText}<br>
                    <strong>Headers:</strong> ${JSON.stringify([...response.headers.entries()])}<br>
                    <strong>URL finale:</strong> ${response.url}
                `, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.text();
                    addResult("Risposta Path Relativo", `<pre>${data}</pre>`, 'info');
                } else {
                    const error = await response.text();
                    addResult("Errore Path Relativo", `<pre>${error}</pre>`, 'error');
                }
                
            } catch (error) {
                addResult("Errore Path Relativo", `<pre>${error.message}</pre>`, 'error');
            }
        }
        
        async function testStep2() {
            addResult("üîç Test 2: Path Assoluti", "Testando path assoluti per l'API...", "info");
            
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.indexOf('/mobile-app/'));
            const absoluteUrl = baseUrl + '/backend/api/calendar-events.php';
            
            try {
                const response = await fetch(absoluteUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                addResult("Path Assoluto", `
                    <strong>URL calcolato:</strong> ${absoluteUrl}<br>
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>StatusText:</strong> ${response.statusText}<br>
                    <strong>Headers:</strong> ${JSON.stringify([...response.headers.entries()])}<br>
                    <strong>URL finale:</strong> ${response.url}
                `, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.text();
                    addResult("Risposta Path Assoluto", `<pre>${data}</pre>`, 'info');
                } else {
                    const error = await response.text();
                    addResult("Errore Path Assoluto", `<pre>${error}</pre>`, 'error');
                }
                
            } catch (error) {
                addResult("Errore Path Assoluto", `<pre>${error.message}</pre>`, 'error');
            }
        }
        
        async function testStep3() {
            addResult("üîç Test 3: Con Parametri", "Testando chiamata API con parametri...", "info");
            
            const today = new Date().toISOString().split('T')[0];
            const url = `../backend/api/calendar-events.php?start=${today}&end=${today}`;
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                addResult("API con Parametri", `
                    <strong>URL:</strong> ${url}<br>
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>StatusText:</strong> ${response.statusText}<br>
                    <strong>Headers:</strong> ${JSON.stringify([...response.headers.entries()])}
                `, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.text();
                    let parsedData;
                    try {
                        parsedData = JSON.parse(data);
                        addResult("Risposta JSON Valida", `<pre>${JSON.stringify(parsedData, null, 2)}</pre>`, 'success');
                    } catch (e) {
                        addResult("Risposta Non-JSON", `<pre>${data}</pre>`, 'warning');
                    }
                } else {
                    const error = await response.text();
                    addResult("Errore API con Parametri", `<pre>${error}</pre>`, 'error');
                }
                
            } catch (error) {
                addResult("Errore Network", `<pre>${error.message}</pre>`, 'error');
            }
        }
        
        async function testStep4() {
            addResult("üîç Test 4: Autenticazione", "Verificando stato autenticazione...", "info");
            
            // Test diretto su una pagina che verifica auth
            try {
                const response = await fetch('../index.php', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const text = await response.text();
                const isLoggedIn = !text.includes('login.php') && !text.includes('form-signin');
                
                addResult("Stato Autenticazione", `
                    <strong>Status index.php:</strong> ${response.status}<br>
                    <strong>Sembra autenticato:</strong> ${isLoggedIn ? 'S√å' : 'NO'}<br>
                    <strong>Contiene redirect login:</strong> ${text.includes('login.php') ? 'S√å' : 'NO'}<br>
                    <strong>Dimensione risposta:</strong> ${text.length} caratteri
                `, isLoggedIn ? 'success' : 'warning');
                
                // Test specifico auth API
                const authResponse = await fetch('../backend/api/check-auth.php', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.text();
                    addResult("Check Auth API", `<pre>${authData}</pre>`, 'info');
                } else {
                    addResult("Check Auth API", `Status: ${authResponse.status} - File probabilmente non esiste`, 'warning');
                }
                
            } catch (error) {
                addResult("Errore Test Autenticazione", `<pre>${error.message}</pre>`, 'error');
            }
        }
        
        async function testStep5() {
            addResult("üîç Test 5: Headers e CORS", "Testando headers e configurazione CORS...", "info");
            
            try {
                const response = await fetch('../backend/api/calendar-events.php', {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type, X-Requested-With'
                    }
                });
                
                const corsHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('access-control')) {
                        corsHeaders[key] = value;
                    }
                });
                
                addResult("Test CORS/OPTIONS", `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>CORS Headers:</strong><br>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                `, response.status === 200 ? 'success' : 'warning');
                
            } catch (error) {
                addResult("Errore Test CORS", `<pre>${error.message}</pre>`, 'error');
            }
        }
        
        function testStep6() {
            addResult("üîç Test 6: Informazioni Browser", "Raccogliendo informazioni sul browser e ambiente...", "info");
            
            const info = {
                userAgent: navigator.userAgent,
                currentURL: window.location.href,
                origin: window.location.origin,
                pathname: window.location.pathname,
                protocol: window.location.protocol,
                host: window.location.host,
                cookiesEnabled: navigator.cookieEnabled,
                cookies: document.cookie,
                referrer: document.referrer,
                localStorage: typeof(Storage) !== "undefined",
                sessionStorage: typeof(Storage) !== "undefined",
                consoleErrors: 'Vedi console del browser (F12)'
            };
            
            addResult("Info Browser/Ambiente", `<pre>${JSON.stringify(info, null, 2)}</pre>`, 'info');
            
            // Test JavaScript loading
            const scriptTags = document.querySelectorAll('script');
            const scripts = Array.from(scriptTags).map(script => ({
                src: script.src || 'inline',
                loaded: script.src ? 'unknown' : 'inline'
            }));
            
            addResult("Script Caricati", `<pre>${JSON.stringify(scripts, null, 2)}</pre>`, 'info');
        }
        
        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult("üèÅ Pagina Caricata", "Test page caricata. Puoi ora eseguire i test.", "success");
            }, 500);
        });
    </script>
</body>
</html>