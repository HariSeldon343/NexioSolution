<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexio PWA Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            color: #2563eb;
            margin-top: 0;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass {
            background-color: #d4edda;
            color: #155724;
        }
        .status.fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.unknown {
            background-color: #fff3cd;
            color: #856404;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Nexio PWA Test Suite</h1>
    
    <div class="test-card">
        <h3>ğŸ“± PWA Features</h3>
        <p>Service Worker: <span id="swStatus" class="status unknown">Checking...</span></p>
        <p>Manifest: <span id="manifestStatus" class="status unknown">Checking...</span></p>
        <p>Install Prompt: <span id="installStatus" class="status unknown">Checking...</span></p>
        <p>Standalone Mode: <span id="standaloneStatus" class="status unknown">Checking...</span></p>
        <p>Online Status: <span id="onlineStatus" class="status unknown">Checking...</span></p>
        
        <button onclick="testPWAFeatures()">ğŸ”„ Refresh Tests</button>
        <button onclick="forceInstallPrompt()">ğŸ“² Trigger Install</button>
    </div>

    <div class="test-card">
        <h3>ğŸ”Œ API Connectivity</h3>
        <p>Task API: <span id="taskApiStatus" class="status unknown">Not tested</span></p>
        <p>Calendar API: <span id="calendarApiStatus" class="status unknown">Not tested</span></p>
        <p>Authentication: <span id="authStatus" class="status unknown">Not tested</span></p>
        
        <button onclick="testAPIs()">ğŸ§ª Test APIs</button>
    </div>

    <div class="test-card">
        <h3>ğŸ’¾ Local Storage & Cache</h3>
        <p>Local Storage: <span id="localStorageStatus" class="status unknown">Not tested</span></p>
        <p>Cache API: <span id="cacheStatus" class="status unknown">Not tested</span></p>
        
        <button onclick="testStorage()">ğŸ’¿ Test Storage</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ Clear Cache</button>
    </div>

    <div class="test-card">
        <h3>ğŸ¯ Performance</h3>
        <p>Load Time: <span id="loadTime" class="status unknown">Measuring...</span></p>
        <p>Resource Count: <span id="resourceCount" class="status unknown">Counting...</span></p>
        
        <button onclick="runPerformanceTest()">âš¡ Performance Test</button>
    </div>

    <div class="test-card">
        <h3>ğŸ“± Quick Actions</h3>
        <button onclick="window.open('./index.html', '_blank')">ğŸ  Open Main App</button>
        <button onclick="window.open('./calendar.html', '_blank')">ğŸ“… Open Calendar</button>
        <button onclick="window.open('./tasks.html', '_blank')">âœ… Open Tasks</button>
        <button onclick="window.open('./offline.html', '_blank')">ğŸ“¡ Test Offline Page</button>
    </div>

    <div class="test-card">
        <h3>ğŸ” Debug Log</h3>
        <div id="debugLog" class="log">Nexio PWA Test Suite initialized...<br></div>
        <button onclick="clearLog()">ğŸ§¹ Clear Log</button>
    </div>

    <script>
        let deferredPrompt = null;
        
        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[Nexio PWA Test] ${message}`);
        }
        
        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message || status.toUpperCase();
        }
        
        function testPWAFeatures() {
            log('Testing PWA features...');
            
            // Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        updateStatus('swStatus', 'pass', 'Registered');
                        log(`Service Worker found: ${registrations[0].scope}`);
                    } else {
                        updateStatus('swStatus', 'fail', 'Not Registered');
                        log('Service Worker not registered');
                    }
                });
            } else {
                updateStatus('swStatus', 'fail', 'Not Supported');
                log('Service Worker not supported');
            }
            
            // Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                fetch(manifestLink.href)
                    .then(response => response.json())
                    .then(manifest => {
                        updateStatus('manifestStatus', 'pass', 'Valid');
                        log(`Manifest loaded: ${manifest.name}`);
                    })
                    .catch(() => {
                        updateStatus('manifestStatus', 'fail', 'Invalid');
                        log('Manifest failed to load');
                    });
            } else {
                updateStatus('manifestStatus', 'fail', 'Missing');
                log('Manifest link not found');
            }
            
            // Install prompt
            updateStatus('installStatus', deferredPrompt ? 'pass' : 'unknown', 
                        deferredPrompt ? 'Available' : 'Waiting');
            
            // Standalone mode
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            updateStatus('standaloneStatus', isStandalone ? 'pass' : 'unknown', 
                        isStandalone ? 'Active' : 'Browser');
            log(`Standalone mode: ${isStandalone}`);
            
            // Online status
            updateStatus('onlineStatus', navigator.onLine ? 'pass' : 'fail', 
                        navigator.onLine ? 'Online' : 'Offline');
        }
        
        async function testAPIs() {
            log('Testing API connectivity...');
            
            // Test Task API
            try {
                const taskResponse = await fetch('../backend/api/task-mobile-api.php?action=auth_check', {
                    credentials: 'same-origin'
                });
                
                if (taskResponse.ok) {
                    const taskData = await taskResponse.json();
                    if (taskData.success) {
                        updateStatus('taskApiStatus', 'pass', 'Connected');
                        updateStatus('authStatus', 'pass', 'Authenticated');
                        log('Task API: Connected and authenticated');
                    } else {
                        updateStatus('taskApiStatus', 'fail', 'Error');
                        updateStatus('authStatus', 'fail', 'Not authenticated');
                        log(`Task API error: ${taskData.error}`);
                    }
                } else {
                    updateStatus('taskApiStatus', 'fail', `HTTP ${taskResponse.status}`);
                    log(`Task API HTTP error: ${taskResponse.status}`);
                }
            } catch (error) {
                updateStatus('taskApiStatus', 'fail', 'Connection Error');
                log(`Task API connection error: ${error.message}`);
            }
            
            // Test Calendar API
            try {
                const today = new Date().toISOString().split('T')[0];
                const calendarResponse = await fetch(`../backend/api/calendar-events.php?start=${today}&end=${today}`, {
                    credentials: 'same-origin'
                });
                
                if (calendarResponse.ok) {
                    const calendarData = await calendarResponse.json();
                    if (calendarData.success) {
                        updateStatus('calendarApiStatus', 'pass', 'Connected');
                        log(`Calendar API: Connected (${calendarData.count} events)`);
                    } else {
                        updateStatus('calendarApiStatus', 'fail', 'Error');
                        log(`Calendar API error: ${calendarData.error}`);
                    }
                } else {
                    updateStatus('calendarApiStatus', 'fail', `HTTP ${calendarResponse.status}`);
                    log(`Calendar API HTTP error: ${calendarResponse.status}`);
                }
            } catch (error) {
                updateStatus('calendarApiStatus', 'fail', 'Connection Error');
                log(`Calendar API connection error: ${error.message}`);
            }
        }
        
        function testStorage() {
            log('Testing storage capabilities...');
            
            // Local Storage
            try {
                const testKey = 'nexio-pwa-test';
                const testValue = { timestamp: Date.now(), test: true };
                localStorage.setItem(testKey, JSON.stringify(testValue));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                if (retrieved && retrieved.test === true) {
                    updateStatus('localStorageStatus', 'pass', 'Working');
                    log('Local Storage: Working correctly');
                    localStorage.removeItem(testKey);
                } else {
                    updateStatus('localStorageStatus', 'fail', 'Failed');
                    log('Local Storage: Failed retrieval test');
                }
            } catch (error) {
                updateStatus('localStorageStatus', 'fail', 'Error');
                log(`Local Storage error: ${error.message}`);
            }
            
            // Cache API
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    if (cacheNames.length > 0) {
                        updateStatus('cacheStatus', 'pass', `${cacheNames.length} caches`);
                        log(`Cache API: ${cacheNames.length} caches found`);
                        cacheNames.forEach(name => log(`  - ${name}`));
                    } else {
                        updateStatus('cacheStatus', 'unknown', 'No caches');
                        log('Cache API: No caches found');
                    }
                }).catch(error => {
                    updateStatus('cacheStatus', 'fail', 'Error');
                    log(`Cache API error: ${error.message}`);
                });
            } else {
                updateStatus('cacheStatus', 'fail', 'Not Supported');
                log('Cache API not supported');
            }
        }
        
        function runPerformanceTest() {
            log('Running performance tests...');
            
            // Load time
            const loadTime = performance.now();
            updateStatus('loadTime', loadTime < 2000 ? 'pass' : 'unknown', `${Math.round(loadTime)}ms`);
            log(`Page load time: ${Math.round(loadTime)}ms`);
            
            // Resource count
            const resources = performance.getEntriesByType('resource');
            updateStatus('resourceCount', 'pass', `${resources.length} resources`);
            log(`Resources loaded: ${resources.length}`);
            
            // Log largest resources
            const sortedResources = resources
                .filter(r => r.transferSize > 0)
                .sort((a, b) => b.transferSize - a.transferSize)
                .slice(0, 5);
                
            log('Largest resources:');
            sortedResources.forEach(resource => {
                log(`  - ${resource.name.split('/').pop()}: ${Math.round(resource.transferSize/1024)}KB`);
            });
        }
        
        function forceInstallPrompt() {
            if (deferredPrompt) {
                log('Showing install prompt...');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    log(`Install prompt result: ${choiceResult.outcome}`);
                    deferredPrompt = null;
                });
            } else {
                log('Install prompt not available');
                alert('Install prompt not available. Try accessing the app from a mobile browser or desktop Chrome.');
            }
        }
        
        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                }).then(() => {
                    log('All caches cleared');
                    updateStatus('cacheStatus', 'unknown', 'Cleared');
                });
            }
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = 'Log cleared...<br>';
        }
        
        // Event listeners
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log('Install prompt captured');
            updateStatus('installStatus', 'pass', 'Available');
        });
        
        window.addEventListener('appinstalled', () => {
            log('PWA installed successfully');
            deferredPrompt = null;
        });
        
        window.addEventListener('online', () => {
            log('Network: Back online');
            updateStatus('onlineStatus', 'pass', 'Online');
        });
        
        window.addEventListener('offline', () => {
            log('Network: Gone offline');
            updateStatus('onlineStatus', 'fail', 'Offline');
        });
        
        // Initialize tests
        document.addEventListener('DOMContentLoaded', () => {
            log('Nexio PWA Test Suite loaded');
            setTimeout(() => {
                testPWAFeatures();
                runPerformanceTest();
            }, 1000);
        });
    </script>
</body>
</html>